---
title: "Probability"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(gradethis)
library(tidyverse)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE)
tutorial_options(exercise.eval = FALSE)
knitr::opts_chunk$set(exercise.checker = gradethis::grade_learnr)
```

## Empirical probability

Let's use our survey data to compute the probability that someone in the class has taken a statistics class before.  First, let's look at the data to remind ourselves of the content:

```{r survey-setup, echo=FALSE, message=FALSE, warning=FALSE}
load_cleaned_survey_data <- function(){
  survey_data <- read_csv('https://raw.githubusercontent.com/poldrack/learnr_demos/master/data/surveydata.csv')
  survey_data_filtered <- filter(survey_data,
                                         year %in% c('1', '2', '3', '4'))
  survey_data_filtered_dropna <- drop_na(survey_data_filtered)
}

survey_data <- load_cleaned_survey_data()
survey_data_by_year <- group_by(survey_data, year)
year4_and_statsbefore <- survey_data$year == "4" & survey_data$stats_before
joint_prob <- mean(year4_and_statsbefore)
p_year4 <- mean(survey_data$year == "4")

```

```{r p_survey, exercise=TRUE, exercise.setup='survey-setup', message=FALSE, warning=FALSE}
survey_data <- load_cleaned_survey_data()
glimpse(survey_data)
```

The variable *stats_before* contains logical values denoting whether the student has had a previous statistics class (TRUE) or not (FALSE).  We want to determine the probability that a student in this group has taken statistics before - that is, the probability that this variable takes the value TRUE.

```{r probcompute_question}
question("Which of the following would correctly compute the probability? Choose all that apply.",
  answer("sum(survey_data$stats_before)/length(survey_data$stats_before)", correct=TRUE),
  answer("mean(survey_data$stats_before)", correct=TRUE),
  answer("mean(survey_data$stats_before == 1)", correct=TRUE),
  answer("sum(survey_data$stats_before/length(survey_data$stats_before))", correct=TRUE),
  random_answer_order = TRUE
)

```

There are two essential facts that one needs to understand in order to make sense of the outcomes on that question.  First, R treats the value TRUE and number 1 as equivalent:

```{r true_one, exercise=TRUE}

TRUE == 1
```

Second, there is a fundamental similarity between the computation of a probability and the computation of the mean.  Here is the equation for computing an empirical probability:

$$
P = \frac{\text{# of events observed}}{\text{# of events counted}}
$$
For example, in the book we computed the probability of rain in San Francisco by dividing the number of days with rain in one year by the total number of days in the year.

Now let's look at the formula for the mean:

$$
\bar{X} = \frac{\sum_1^N{x_i}}{N}
$$

In this case, the $x_i$ are the observed values, and N is the total number of values.  If the $x_i$ take values of one (when the event happens) or zero (when the event doesn't happen), then the top of this equation is just computing the number of times the event happens, and $N$ is the total number of observations -- which is exactly the equation for computing the probability!

#### Exercise

Use the `mean()` function to compute the probability of having taken a statistics class before.

```{r mean_prog, exercise=TRUE, exercise.setup='survey-setup'}

p_stats_before <- ...
p_stats_before

```

```{r mean_prog-solution, warning=FALSE}
p_stats_before <- mean(survey_data$stats_before)
p_stats_before
```

```{r mean_prog-check}
grade_code(incorrect='Try again...')
```

## Conditional probability

Conditional probability is the probability of some event occurring, given that some other event has occurred. We can compute this as follows:

$$
P(A|B) = \frac{P(A \cap B)}{P(B)}
$$
That is, we count occurrences of A *and* B, but then divide by the probability of B. This is equivalent to saying that we are going to count how many times A occurs, but only for the events where B occurred.

Let's compute the conditional probability of someone having taken a statistics class before, given that they are a first-year student.

$$
P(\text{stats before}|\text{year 4}) = \frac{P(\text{stats before} \cap \text{year 4})}{P(\text{year 4})}
$$
#### Exercise:

Use the mean to compute compute $P(\text{year 4})$.  Here again you can take advantage of the fact that we can simply take the mean of a logical value to compute the probability -- in this case, the logical values are generated by the *==* test for whether each value is equal to the value "4" (we have to use the quotes because the year values are stored in the variable as character strings).  

```{r p_year4, exercise=TRUE, exercise.setup='survey-setup'}

p_year4 <- ...
p_year4

```

```{r p_year4-solution, warning=FALSE}
p_year4 <- mean(survey_data$year == "4")
p_year4
```

```{r p_year4-check}
grade_code(incorrect='Try again...')
```


Next, let's compute the joint probability of having taken stats before and being year 4 ($P(\text{stats before} \cap \text{year 4})$).  You might remember that in the book we discussed how one can sometimes compute the joint probability simply by multiplying the individual probabilities, but that only works if the events are independent; in this case we don't know whether or not they are independent, so we will compute the joint probability by first creating a new variable that represents the joint event (year 4 and having taken stats before) and then computing the probability as usual:

```{r jointprob, exercise=TRUE, exercise.setup='survey-setup'}
year4_and_statsbefore <- survey_data$year == "4" & survey_data$stats_before
joint_prob <- mean(year4_and_statsbefore)
joint_prob
```

Given this, we can now compute the conditional probability $P(\text{stats before}|\text{year 4}) $:

```{r condprob, exercise=TRUE, exercise.setup='survey-setup'}

p_statsbefore_given_year4 <- joint_prob / p_year4
p_statsbefore_given_year4
```

## Probability distributions

A probability distribution provides us with a way to compute the likelihood of some particular event, given some assumptions about how the events are generated.  One example that we encountered in the book is the *binomial* distribution, which is appropriate for determining the likelihood of a number of outcomes on a set of trials with binary (success or failure) outcomes (known as *Bernoulli trials*). 

The Astra-Zeneca clinical trial of the COVID-19 vaccine, which aimed to enroll 30,000 patients, was halted on Sept 6, 2020 after one of the patients in the study developed a serious condition known as *transverse myelitis*, which attacks the nervous system.  This disorder occurs in roughly 4 in every million people in any year.  What we would like to know is: How likely would it be for one or more of the people in the study to develop this disorder due to random chance (that is, not as a side effect of the vaccine)?

We can use the `pbinom()` function to compute this.  This function takes three arguments:

- the number of "successes" (in this case, the number of patients with the disease)
- the number of "trials" (in this case, the number of patients in the study - we don't actually know how many were enrolled before the study was stopped, so we will just use the full 30,000 as our estimate)
- the probability of the event occurring (based on the natural occurrence rate of 4 per million people)

Because we want to know the probability of 1 or more cases of transverse myelitis (rather than the probability of exactly one case), we must use the *lower.tail=FALSE* argument, so that the function will return the "upper tail" of the distribution.


```{r pbinom, exercise=TRUE}
p_transverse_myelitis <- 4 / 1000000
n_patients <- 30000
n_observed_TM <- 1

pbinom(n_observed_TM, n_patients, p_transverse_myelitis, lower.tail=FALSE)
```

This tells us that the likelihood of one or more people developing transverse myelitis by chance out of 30,000 people is about 0.007, or about seven out of 1000.  This is a relatively small chance, but not completely out of the question.

#### Exercise

A local election is being held in which 48% of the registered voters support candidate Jerry Garcia and 52% support candidate Robert Plant.  The turnout of the election is 500 voters.  What is the likelihood that candidate Garcia will win the election with more 50% of the vote?

```{r election, exercise=TRUE, exercise.setup='survey-setup'}
# probability that someone will vote for Garcia
p_garcia <- ...
# number of voters
n_voters <- ...
# number of votes needed to win
n_voters_to_win <- ...

p_garcia_wins <- ...
p_garcia_wins

```

```{r election-solution}
p_garcia <- 0.48
n_voters <- 500
n_voters_to_win <- 251

p_garcia_wins <- pbinom(n_voters_to_win, n_voters, p_garcia, lower.tail=FALSE)
p_garcia_wins
```

```{r election-check}
grade_code(incorrect='Try again...')
```
